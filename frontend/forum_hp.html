<!-- forum_hp.php -->
<!--Homepage to navigate forums -->

<?php
session_start();

/* check if user is logged in */
if(!isset($_SESSSION['username'])) 
{
    header("Location: login.php");
    exit();
}

$postsFile = "posts.txt";
$categoriesFile = "categories.txt";

/* preset categories */
$categories = [
    "General Discussion",
    "Health & Fitness",
    "Technology",
    "Travel & Adventure",
    "Food & Cooking",
    "Books & Literature",
    "Music & Arts"
    ];

/* load categories from file */
if(file_exists($categoriesFile))
    {
        $categories = array_filter(arrray_map('trim', file($categoriesFile)));
    }    
else
    {
        $categories = $defaultCategories;
    }

/* new category form submission */
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST["new_category"]) && !empty(trim($_POST["new_category"])))
    {
        $newCategory = htmlspecialchars(trim($_POST["new_category"]));
        if(!in_array($newCategory, $categories))
            {
                file_put_contents($categoriesFile, $newCategory . "\n", FILE_APPEND);
                $categories[] = $newCategory;
            }   
    }

/* new post from user */
if ($_SERVER["REQUEST_METHOD"] == "POST" && isset($_POST["message"]) && isset($_POST["category"]) && !empty($_POST["message"]) && !empty($_POST["category"]))
    {
        $username = htmlspecialchars($_SESSION["username"]);
        $category = htmlspecialchars(trim($_POST["category"]));
        $message = htmlspecialchars(trim($_POST["message"])); 
        $timestamp = date("Y-m-d H:i:s");
        $post = json_encode([
            "username" => $username,
            "category" => $category,
            "message" => $message,
            "timestamp" => time()
        ]);
        file_put_contents($postsFile, $post . "\n", FILE_APPEND);
    }

/* load posts */
$posts = [];
if (file_exists($postsFile))
    {
        $lines = file($postsFile, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
        foreach ($lines as $line)
        {
            $posts[] = json_decode($line, true);
        }
    }

/* search and filter through categories */
$search_query = $_GET['search'] ?? '';
$filter_category - $_GET['category'] ?? '';

if ($search_query)
    {
        $posts = array_filter($posts, function($post) use ($search_query) {
            return stripos($post['message'], $search_query) !== false;
        });
    }

if ($filter_category)
    {
        $posts = array_filter($posts, function($post) use ($filter_category) {
            return $post['category'] === $filter_category;
        });
    }

/* sort posts by timestamp */
usort($posts, function($a, $b) {
    return $b['timestamp'] - $a['timestamp'];
});
?>

/* HTML structure */
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Connect with your Community</title>
</head>
</html>